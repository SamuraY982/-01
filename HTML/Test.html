<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Exchange UI (Mock)</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --line:#e9edf3;
      --muted:#7a8699;
      --text:#111827;
      --green:#22c55e;
      --red:#ef4444;
      --orange:#f59e0b;
      --shadow: 0 8px 18px rgba(17,24,39,.06);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:linear-gradient(#fff, #fbfcff);
    }

    /* Page shell */
    .wrap{
      max-width: 1400px;
      margin: 18px auto;
      padding: 0 14px 22px;
    }

    .grid{
      display:grid;
      grid-template-columns: 320px 1fr 340px;
      gap:14px;
      align-items:stretch;
    }

    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .title{
      font-weight:700;
      font-size:14px;
      letter-spacing:.2px;
    }
    .sub{
      font-size:12px;
      color:var(--muted);
    }

    /* Left: Order Book */
    .ob{
      display:flex;
      flex-direction:column;
      height: 640px;
    }
    .ob .body{
      padding:0;
      display:flex;
      flex-direction:column;
      height:100%;
    }
    .ob .thead{
      display:grid;
      grid-template-columns: 1.1fr 1fr 1fr;
      gap:0;
      padding:10px 12px;
      font-size:12px;
      color:var(--muted);
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .ob .rows{
      display:flex;
      flex-direction:column;
      height:100%;
      overflow:auto;
    }
    .ob .row{
      position:relative;
      display:grid;
      grid-template-columns: 1.1fr 1fr 1fr;
      padding:7px 12px;
      font-family:var(--mono);
      font-size:12px;
      border-bottom:1px dashed rgba(233,237,243,.6);
    }
    .ob .row:last-child{ border-bottom:none; }
    .ob .row .bgbar{
      position:absolute;
      top:0; bottom:0;
      right:0;
      width:0%;
      opacity:.16;
      pointer-events:none;
    }
    .ob .row.ask .bgbar{ background:var(--red); }
    .ob .row.bid .bgbar{ background:var(--green); }
    .ob .price.ask{ color:var(--red); }
    .ob .price.bid{ color:var(--green); }
    .ob .mid{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-top:1px solid var(--line);
      border-bottom:1px solid var(--line);
      background:#fff;
      font-family:var(--mono);
    }
    .ob .mid .mp{
      font-weight:800;
      font-size:14px;
    }
    .pill{
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background:#fff;
    }

    /* Center: Chart + order forms */
    .center{
      display:flex;
      flex-direction:column;
      height: 640px;
      gap:14px;
    }

    .pairbar{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .coin{
      display:inline-flex;
      width:26px; height:26px;
      align-items:center; justify-content:center;
      border-radius:50%;
      background:#fff7ed;
      border:1px solid #ffedd5;
      font-weight:900;
      color:#f97316;
    }
    .pair{
      font-weight:800;
      letter-spacing:.2px;
    }
    .kpis{
      display:flex;
      gap:18px;
      align-items:center;
      flex-wrap:wrap;
    }
    .kpi{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 110px;
    }
    .kpi .k{ font-size:12px; color:var(--muted); }
    .kpi .v{ font-size:13px; font-weight:700; font-family:var(--mono); }

    .chart{
      height: 390px;
    }
    .chart .body{
      padding: 10px 12px 12px;
    }
    canvas{
      width:100%;
      height: 330px;
      display:block;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
    }

    .forms{
      flex:1;
      min-height: 0;
    }
    .forms .body{
      padding:0;
    }
    .tabs{
      display:flex;
      gap:0;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .tab{
      padding:12px 14px;
      font-size:13px;
      color:var(--muted);
      border-bottom:2px solid transparent;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      color:var(--text);
      border-bottom-color:var(--orange);
      font-weight:700;
    }
    .formsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      padding:12px;
    }
    .formBox{
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      background:#fff;
    }
    .avail{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
      color:var(--muted);
      margin-bottom:10px;
    }
    .input{
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:#fff;
      margin-bottom:10px;
    }
    .input input{
      border:none;
      outline:none;
      font-size:14px;
      width:100%;
      font-family:var(--mono);
    }
    .suffix{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .percent{
      display:flex;
      gap:8px;
      margin: 8px 0 10px;
    }
    .pctBtn{
      flex:1;
      font-size:12px;
      padding:8px 0;
      border-radius:999px;
      border:1px solid #f6d58b;
      background:#fff7ed;
      color:#a16207;
      cursor:pointer;
      user-select:none;
      text-align:center;
      font-weight:700;
    }
    .pctBtn:hover{ filter:brightness(.98); }
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      display:flex;
      justify-content:space-between;
    }
    .btn{
      width:100%;
      border:none;
      border-radius:12px;
      padding:12px 12px;
      font-weight:800;
      cursor:pointer;
      font-size:14px;
      margin-top:10px;
    }
    .btn.buy{ background:rgba(34,197,94,.92); color:white; }
    .btn.sell{ background:rgba(239,68,68,.92); color:white; }
    .btn:active{ transform: translateY(1px); }

    /* Right: Trades + Markets */
    .right{
      display:flex;
      flex-direction:column;
      height: 640px;
      gap:14px;
    }
    .trades{
      height: 270px;
    }
    .trades .body{ padding:0; height:100%; display:flex; flex-direction:column; }
    .tHead{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      padding:10px 12px;
      font-size:12px;
      color:var(--muted);
      border-bottom:1px solid var(--line);
    }
    .tRows{
      overflow:auto;
      height:100%;
    }
    .tRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      padding:8px 12px;
      font-family:var(--mono);
      font-size:12px;
      border-bottom:1px dashed rgba(233,237,243,.65);
    }
    .tRow:last-child{ border-bottom:none; }
    .tRow .p.up{ color:var(--green); }
    .tRow .p.down{ color:var(--red); }

    .markets{
      flex:1;
      min-height:0;
    }
    .markets .body{ padding:10px 12px 12px; height:100%; display:flex; flex-direction:column; gap:10px; }
    .search{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 10px;
      display:flex;
      gap:10px;
      align-items:center;
      background:#fff;
    }
    .search input{
      border:none;
      outline:none;
      width:100%;
      font-size:14px;
    }
    .mTable{
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      background:#fff;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .mHead{
      display:grid;
      grid-template-columns: 1.2fr 1fr .8fr;
      padding:10px 12px;
      font-size:12px;
      color:var(--muted);
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .mRows{
      overflow:auto;
      min-height:0;
    }
    .mRow{
      display:grid;
      grid-template-columns: 1.2fr 1fr .8fr;
      padding:10px 12px;
      border-bottom:1px dashed rgba(233,237,243,.65);
      font-family:var(--mono);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .mRow:last-child{ border-bottom:none; }
    .mRow .chg.up{ color:var(--green); font-weight:800; }
    .mRow .chg.down{ color:var(--red); font-weight:800; }
    .mRow.active{ background:#f8fafc; }

    /* Footer info bar */
    .status{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      color:var(--muted);
      font-size:12px;
    }
    .status b{ color:var(--text); }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
    }

    /* Responsive */
    @media (max-width: 1180px){
      .grid{ grid-template-columns: 320px 1fr; }
      .right{ grid-column: 1 / -1; height:auto; }
      .ob, .center{ height:auto; }
      .chart{ height:auto; }
      canvas{ height: 320px; }
    }
    @media (max-width: 760px){
      .grid{ grid-template-columns: 1fr; }
      .formsGrid{ grid-template-columns: 1fr; }
      .ob{ height: 520px; }
      .trades{ height: 260px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">

      <!-- LEFT: ORDER BOOK -->
      <section class="card ob">
        <div class="hd">
          <div>
            <div class="title">Order Book</div>
            <div class="sub">Price (USDT) â€¢ Size (BTC) â€¢ Total (USDT)</div>
          </div>
          <span class="pill" id="obSpread">Spread: â€”</span>
        </div>

        <div class="body">
          <div class="thead">
            <div>Price (USDT)</div><div>Size (BTC)</div><div>Total (USDT)</div>
          </div>

          <div class="rows" id="asks"></div>

          <div class="mid">
            <div>
              <div class="sub">Mark</div>
              <div class="mp" id="markPrice">â€”</div>
            </div>
            <div style="text-align:right">
              <div class="sub">Last</div>
              <div class="mp" id="lastPrice">â€”</div>
            </div>
          </div>

          <div class="rows" id="bids"></div>
        </div>
      </section>

      <!-- CENTER: CHART + FORMS -->
      <section class="center">

        <section class="card chart">
          <div class="hd">
            <div class="pairbar">
              <span class="coin">â‚¿</span>
              <div>
                <div class="pair" id="pairName">BTC/USDT</div>
                <div class="sub" id="pairUsd">â‰ˆ $â€”</div>
              </div>
            </div>

            <div class="kpis">
              <div class="kpi">
                <div class="k">Last</div>
                <div class="v" id="kLast">â€”</div>
              </div>
              <div class="kpi">
                <div class="k">24h Change</div>
                <div class="v" id="kChg">â€”</div>
              </div>
              <div class="kpi">
                <div class="k">24h High</div>
                <div class="v" id="kHigh">â€”</div>
              </div>
              <div class="kpi">
                <div class="k">24h Low</div>
                <div class="v" id="kLow">â€”</div>
              </div>
              <div class="kpi">
                <div class="k">24h Volume (BTC)</div>
                <div class="v" id="kVol">â€”</div>
              </div>
              <div class="kpi">
                <div class="k">24h Volume (USDT)</div>
                <div class="v" id="kVolQ">â€”</div>
              </div>
            </div>
          </div>

          <div class="body">
            <canvas id="chart"></canvas>
            <div class="status">
              <span class="badge">Timeframe: <b>1m</b></span>
              <span class="badge">Mode: <b>Mock live feed</b></span>
              <span class="badge">Balance: <b id="balUsdt">â€”</b> USDT â€¢ <b id="balBtc">â€”</b> BTC</span>
            </div>
          </div>
        </section>

        <section class="card forms">
          <div class="tabs">
            <div class="tab" data-tab="limit">Limit</div>
            <div class="tab active" data-tab="market">Market</div>
            <div class="tab" data-tab="trigger">Trigger Order</div>
          </div>

          <div class="body">
            <div class="formsGrid">

              <!-- BUY -->
              <div class="formBox">
                <div class="avail"><span>Available</span><b id="availBuy">0.00 USDT</b></div>

                <div class="input">
                  <input id="buyPrice" type="text" disabled value="Market Price" />
                </div>

                <div class="input">
                  <input id="buyAmount" type="number" step="0.01" min="0" placeholder="Amount" />
                  <span class="suffix">USDT</span>
                </div>

                <div class="percent">
                  <div class="pctBtn" data-side="buy" data-pct="25">25%</div>
                  <div class="pctBtn" data-side="buy" data-pct="50">50%</div>
                  <div class="pctBtn" data-side="buy" data-pct="75">75%</div>
                  <div class="pctBtn" data-side="buy" data-pct="100">100%</div>
                </div>

                <div class="hint">
                  <span>Get per purchase</span><b id="buyGet">0</b>
                </div>

                <button class="btn buy" id="btnBuy">Buy BTC</button>
              </div>

              <!-- SELL -->
              <div class="formBox">
                <div class="avail"><span>Available</span><b id="availSell">0.00000000 BTC</b></div>

                <div class="input">
                  <input id="sellPrice" type="text" disabled value="Market Price" />
                </div>

                <div class="input">
                  <input id="sellAmount" type="number" step="0.00000001" min="0" placeholder="Amount" />
                  <span class="suffix">BTC</span>
                </div>

                <div class="percent">
                  <div class="pctBtn" data-side="sell" data-pct="25">25%</div>
                  <div class="pctBtn" data-side="sell" data-pct="50">50%</div>
                  <div class="pctBtn" data-side="sell" data-pct="75">75%</div>
                  <div class="pctBtn" data-side="sell" data-pct="100">100%</div>
                </div>

                <div class="hint">
                  <span>Get per sale</span><b id="sellGet">0</b>
                </div>

                <button class="btn sell" id="btnSell">Sell BTC</button>
              </div>

            </div>
          </div>
        </section>
      </section>

      <!-- RIGHT: TRADES + MARKETS -->
      <section class="right">

        <section class="card trades">
          <div class="hd">
            <div>
              <div class="title">Trades</div>
              <div class="sub">Price (USDT) â€¢ Size â€¢ Time</div>
            </div>
            <span class="pill" id="tradeMode">Live</span>
          </div>

          <div class="body">
            <div class="tHead">
              <div>Price (USDT)</div><div>Size (BTC)</div><div>Time</div>
            </div>
            <div class="tRows" id="tradeRows"></div>
          </div>
        </section>

        <section class="card markets">
          <div class="hd">
            <div class="title">Markets</div>
            <div class="sub">Search + click pair</div>
          </div>

          <div class="body">
            <div class="search">
              <span style="color:var(--muted)">ðŸ”Ž</span>
              <input id="marketSearch" placeholder="Search" />
            </div>

            <div class="mTable">
              <div class="mHead">
                <div>Currency</div><div>Last</div><div>Change</div>
              </div>
              <div class="mRows" id="marketRows"></div>
            </div>
          </div>
        </section>

      </section>
    </div>
  </div>

<script>
(() => {
  // ---------- helpers ----------
  const fmt = (n, d=2) => Number(n).toLocaleString("en-US", {minimumFractionDigits:d, maximumFractionDigits:d});
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const nowTime = () => {
    const d = new Date();
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${dd}/${mm} ${hh}:${mi}`;
  };

  // ---------- state ----------
  // price direction control
// "up" | "down" | "auto"
let priceDirection = "auto";

  
  // chart zoom / pan
  let visibleCandles = 40;
  let minCandles = 10;
  let maxVisibleCandles = 120;
  let candleOffset = 0;

  let pair = "BTC/USDT";
  let base = "BTC";
  let quote = "USDT";

  // balances (mock)
  let bal = { USDT: 2500.00, BTC: 0.03500000 };

  // candle series (mock)
  const candles = [];
  const maxCandles = 60;
  let last = 115186.99;
  let open24 = last / 1.0262; // approximate so change ~2.62%
  let hi24 = last * 1.010;
  let lo24 = last * 0.985;
  let vol24 = 2152.0;
  let vol24q = 246_843_008;

  // markets list (mock)
  const markets = [
    { sym:"BTC/USDT", last:115186.99, chg: 2.62 },
    { sym:"ETH/USDT", last:4146.10,   chg: 4.67 },
    { sym:"BNB/USDT", last:1168.34,   chg: 2.38 },
    { sym:"SOL/USDT", last:199.28,    chg: 2.65 },
    { sym:"USDC/USDT",last:0.9999,    chg: 0.01 },
    { sym:"XRP/USDT", last:2.6239,    chg:-0.24 },
    { sym:"DOGE/USDT",last:0.20234,   chg: 2.10 },
    { sym:"TON/USDT", last:2.209,     chg: 2.21 },
    { sym:"TRX/USDT", last:0.2991,    chg: 1.01 },
    { sym:"ADA/USDT", last:0.6739,    chg: 2.22 },
    { sym:"AVAX/USDT",last:20.41,     chg: 2.90 },
  ];

  // orderbook (mock)
  const book = { asks: [], bids: [] };

  // trades (mock)
  const trades = [];

  // ---------- DOM ----------
  const el = (id) => document.getElementById(id);

  const asksEl = el("asks");
  const bidsEl = el("bids");
  const markEl = el("markPrice");
  const lastEl = el("lastPrice");
  const obSpreadEl = el("obSpread");

  const kLast = el("kLast");
  const kChg  = el("kChg");
  const kHigh = el("kHigh");
  const kLow  = el("kLow");
  const kVol  = el("kVol");
  const kVolQ = el("kVolQ");

  const pairName = el("pairName");
  const pairUsd = el("pairUsd");

  const balUsdt = el("balUsdt");
  const balBtc = el("balBtc");
  const availBuy = el("availBuy");
  const availSell = el("availSell");

  const buyAmount = el("buyAmount");
  const sellAmount = el("sellAmount");
  const buyGet = el("buyGet");
  const sellGet = el("sellGet");

  const tradeRows = el("tradeRows");
  const marketRows = el("marketRows");
  const marketSearch = el("marketSearch");

  // chart
  const canvas = el("chart");
  const ctx = canvas.getContext("2d");

  const resizeCanvas = () => {
    const ratio = Math.max(1, window.devicePixelRatio || 1);
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * ratio);
    canvas.height = Math.floor(rect.height * ratio);
    ctx.setTransform(ratio,0,0,ratio,0,0);
  };

  // ---------- init ----------
  function seedCandles() {
    candles.length = 0;
    let p = last;
    for (let i=0; i<maxCandles; i++){
      const o = p;
      const drift = (Math.random()-0.48) * (last*0.0018);
      const c = Math.max(1, o + drift);
      const h = Math.max(o,c) + Math.random()*(last*0.0012);
      const l = Math.min(o,c) - Math.random()*(last*0.0012);
      const v = 20 + Math.random()*120;
      candles.push({ o, h, l, c, v });
      p = c;
    }
    last = candles[candles.length-1].c;
  }

  function genBook() {
    book.asks = [];
    book.bids = [];
    const spread = last * 0.00008;
    const midAsk = last + spread/2;
    const midBid = last - spread/2;

    let askP = midAsk;
    let bidP = midBid;

    for (let i=0;i<18;i++){
      askP += (last*0.00005) * (0.7 + Math.random());
      const size = (Math.random() * 0.18) + 0.0005;
      book.asks.push({ p: askP, s: size });
    }
    for (let i=0;i<18;i++){
      bidP -= (last*0.00005) * (0.7 + Math.random());
      const size = (Math.random() * 0.18) + 0.0005;
      book.bids.push({ p: bidP, s: size });
    }
  }

  function pushTrade(price, size, dir) {
    trades.unshift({ price, size, dir, time: nowTime() });
    if (trades.length > 80) trades.pop();
  }

  function seedTrades() {
    trades.length=0;
    for (let i=0;i<22;i++){
      const dir = Math.random() > 0.5 ? "up" : "down";
      const price = last + (Math.random()-0.5) * (last*0.0009);
      const size = (Math.random()*0.45) + 0.00009;
      pushTrade(price, size, dir);
    }
  }

  // ---------- renderers ----------
  function renderBalances() {
    balUsdt.textContent = fmt(bal.USDT, 2);
    balBtc.textContent  = fmt(bal.BTC, 8);
    availBuy.textContent = `${fmt(bal.USDT, 2)} ${quote}`;
    availSell.textContent = `${fmt(bal.BTC, 8)} ${base}`;
  }

  function renderKPIs() {
    const chg = ((last - open24) / open24) * 100;
    kLast.textContent = fmt(last, 2);
    kChg.textContent = `${chg >= 0 ? "+" : ""}${fmt(chg, 2)}%`;
    kChg.style.color = chg >= 0 ? "var(--green)" : "var(--red)";
    kHigh.textContent = fmt(hi24, 0);
    kLow.textContent  = fmt(lo24, 2);
    kVol.textContent  = fmt(vol24, 0);
    kVolQ.textContent = fmt(vol24q, 2);

    pairName.textContent = pair;
    pairUsd.textContent = `â‰ˆ $${fmt(last, 2)}`;

    lastEl.textContent = fmt(last, 2);
    markEl.textContent = fmt(last, 2);
  }

  function renderBook() {
    // compute max totals for bar widths
    const asksTotals = book.asks.map(x => x.p * x.s);
    const bidsTotals = book.bids.map(x => x.p * x.s);
    const maxTotal = Math.max(...asksTotals, ...bidsTotals, 1);

    asksEl.innerHTML = "";
    // asks show from top (higher) down (like many exchanges)
    [...book.asks].reverse().forEach(x => {
      const total = x.p * x.s;
      const row = document.createElement("div");
      row.className = "row ask";
      row.innerHTML = `
        <div class="price ask">${fmt(x.p, 2)}</div>
        <div>${fmt(x.s, 8)}</div>
        <div>${fmt(total, 2)}</div>
        <div class="bgbar"></div>
      `;
      const bg = row.querySelector(".bgbar");
      bg.style.width = `${(total/maxTotal)*100}%`;
      asksEl.appendChild(row);
    });

    bidsEl.innerHTML = "";
    book.bids.forEach(x => {
      const total = x.p * x.s;
      const row = document.createElement("div");
      row.className = "row bid";
      row.innerHTML = `
        <div class="price bid">${fmt(x.p, 2)}</div>
        <div>${fmt(x.s, 8)}</div>
        <div>${fmt(total, 2)}</div>
        <div class="bgbar"></div>
      `;
      const bg = row.querySelector(".bgbar");
      bg.style.width = `${(total/maxTotal)*100}%`;
      bidsEl.appendChild(row);
    });

    const bestAsk = book.asks[0]?.p ?? last;
    const bestBid = book.bids[0]?.p ?? last;
    const spread = Math.max(0, bestAsk - bestBid);
    obSpreadEl.textContent = `Spread: ${fmt(spread, 2)}`;
  }

  function renderTrades() {
    tradeRows.innerHTML = "";
    trades.slice(0, 40).forEach(t => {
      const row = document.createElement("div");
      row.className = "tRow";
      row.innerHTML = `
        <div class="p ${t.dir}">${fmt(t.price, 2)}</div>
        <div>${fmt(t.size, 8)}</div>
        <div>${t.time}</div>
      `;
      tradeRows.appendChild(row);
    });
  }

  function renderMarkets(filter="") {
    const f = filter.trim().toUpperCase();
    marketRows.innerHTML = "";
    markets
      .filter(m => !f || m.sym.toUpperCase().includes(f))
      .forEach(m => {
        const row = document.createElement("div");
        row.className = "mRow" + (m.sym === pair ? " active" : "");
        const up = m.chg >= 0;
        row.innerHTML = `
          <div style="font-family:var(--sans); font-weight:800">${m.sym}</div>
          <div>${fmt(m.last, m.last < 10 ? 4 : 2)}</div>
          <div class="chg ${up ? "up" : "down"}">${up ? "+" : ""}${fmt(m.chg, 2)}%</div>
        `;
        row.onclick = () => switchPair(m.sym);
        marketRows.appendChild(row);
      });
  }

  // ---------- chart ----------
  function drawChart() {
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;

    // background
    ctx.clearRect(0,0,w,h);

    // margins
    const padL = 52, padR = 10, padT = 10, padB = 26;
    const vh = 70; // volume height
    const ph = h - padT - padB - vh;

    // visible window
    const end = candles.length - candleOffset;
    const start = Math.max(0, end - visibleCandles);
    const data = candles.slice(start, end);
    const highs = data.map(d => d.h);
    const lows  = data.map(d => d.l);
    const maxP = Math.max(...highs);
    const minP = Math.min(...lows);
    const range = Math.max(1e-9, maxP - minP);

    const maxV = Math.max(...data.map(d => d.v), 1);

    // grid
    ctx.lineWidth = 1;
    ctx.strokeStyle = "#eef2f7";
    ctx.fillStyle = "#6b7280";
    ctx.font = "12px var(--mono)";

    const gridY = 6;
    for (let i=0;i<=gridY;i++){
      const y = padT + (ph/gridY)*i;
      ctx.beginPath();
      ctx.moveTo(padL, y);
      ctx.lineTo(w-padR, y);
      ctx.stroke();

      const p = maxP - (range/gridY)*i;
      ctx.fillText(fmt(p, 0), 6, y+4);
    }

    // candle geometry
    const n = data.length;
    const plotW = (w - padL - padR);
    const step = plotW / n;
    const cw = Math.max(4, step*0.62);

    function yPrice(p){
      return padT + (maxP - p) / range * ph;
    }

    // candles
    for (let i=0;i<n;i++){
      const d = data[i];
      const x = padL + i*step + step/2;

      const yO = yPrice(d.o);
      const yC = yPrice(d.c);
      const yH = yPrice(d.h);
      const yL = yPrice(d.l);

      const up = d.c >= d.o;
      const col = up ? getComputedStyle(document.documentElement).getPropertyValue('--green').trim()
                     : getComputedStyle(document.documentElement).getPropertyValue('--red').trim();

      // wick
      ctx.strokeStyle = col;
      ctx.beginPath();
      ctx.moveTo(x, yH);
      ctx.lineTo(x, yL);
      ctx.stroke();

      // body
      const top = Math.min(yO, yC);
      const bot = Math.max(yO, yC);
      const bh = Math.max(2, bot - top);
      ctx.fillStyle = col;
      ctx.fillRect(x - cw/2, top, cw, bh);

      // volume
      const vH = (d.v / maxV) * (vh-10);
      const vy = padT + ph + (vh-6) - vH;
      ctx.globalAlpha = 0.35;
      ctx.fillRect(x - cw/2, vy, cw, vH);
      ctx.globalAlpha = 1;
    }

    // last price line
    const yLpx = yPrice(last);
    ctx.setLineDash([4,4]);
    ctx.strokeStyle = "#cbd5e1";
    ctx.beginPath();
    ctx.moveTo(padL, yLpx);
    ctx.lineTo(w-padR, yLpx);
    ctx.stroke();
    ctx.setLineDash([]);

    // last label
    ctx.fillStyle = "#fff";
    ctx.strokeStyle = "#e5e7eb";
    const label = fmt(last, 2);
    const tw = ctx.measureText(label).width + 14;
    const lx = w - padR - tw;
    const ly = clamp(yLpx-12, padT+6, padT+ph-22);
    ctx.fillStyle = "rgba(239,68,68,.92)";
    ctx.fillRect(lx, ly, tw, 22);
    ctx.fillStyle = "#fff";
    ctx.fillText(label, lx+8, ly+15);
  }

  // ---------- trading interactions ----------
  function recalcFormHints() {
    const buyUSDT = Number(buyAmount.value || 0);
    const sellBTC = Number(sellAmount.value || 0);

    const buyBTC = buyUSDT > 0 ? buyUSDT / last : 0;
    const sellUSDT = sellBTC > 0 ? sellBTC * last : 0;

    buyGet.textContent = buyBTC ? fmt(buyBTC, 8) : "0";
    sellGet.textContent = sellUSDT ? fmt(sellUSDT, 2) : "0";
  }

  function buyMarket() {
    const usdt = Number(buyAmount.value || 0);
    if (!(usdt > 0)) return alert("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÑƒÐ¼Ð¼Ñƒ USDT Ð´Ð»Ñ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸.");
    if (usdt > bal.USDT) return alert("ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ USDT.");

    const btc = usdt / last;
    bal.USDT -= usdt;
    bal.BTC  += btc;

    pushTrade(last, btc, "up");
    renderBalances();
    renderTrades();
    recalcFormHints();
  }

  function sellMarket() {
    const btc = Number(sellAmount.value || 0);
    if (!(btc > 0)) return alert("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ BTC Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð¸.");
    if (btc > bal.BTC) return alert("ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ BTC.");

    const usdt = btc * last;
    bal.BTC  -= btc;
    bal.USDT += usdt;

    pushTrade(last, btc, "down");
    renderBalances();
    renderTrades();
    recalcFormHints();
  }

  // ---------- pair switching ----------
  function switchPair(sym) {
    pair = sym;
    [base, quote] = sym.split("/");
    // set last according to market
    const m = markets.find(x => x.sym === sym);
    if (m) last = m.last;

    // change header icon roughly
    const coin = document.querySelector(".coin");
    coin.textContent = base === "BTC" ? "â‚¿" : base[0];

    // reset 24h stats
    open24 = last / (1 + (m?.chg ?? 0)/100);
    hi24 = last * (1.006 + Math.random()*0.01);
    lo24 = last * (0.985 - Math.random()*0.01);
    vol24 = 1200 + Math.random()*2600;
    vol24q = vol24 * last;

    seedCandles();
    genBook();
    seedTrades();

    renderKPIs();
    renderBook();
    renderTrades();
    renderMarkets(marketSearch.value);
    drawChart();

    // update form labels/buttons
    document.getElementById("btnBuy").textContent = `Buy ${base}`;
    document.getElementById("btnSell").textContent = `Sell ${base}`;
    document.querySelectorAll(".suffix").forEach(s => {
      // first suffix in buy is USDT, second in sell is base â€” already OK
    });

    // reset inputs
    buyAmount.value = "";
    sellAmount.value = "";
    recalcFormHints();
  }

  // ---------- live updates (mock) ----------
  function stepMarket() {
    // random walk with small volatility
    const drift = (Math.random()-0.48) * (last * 0.0009);
    const next = Math.max(0.0001, last + drift);

    // update current candle (last candle in series)
    const cur = candles[candles.length-1];
    cur.c = next;
    cur.h = Math.max(cur.h, next);
    cur.l = Math.min(cur.l, next);
    cur.v += 2 + Math.random()*8;

    last = next;

    // occasional new candle
    if (Math.random() < 0.12){
      const o = last;
      const c = last + (Math.random()-0.5)*(last*0.0013);
      const h = Math.max(o,c) + Math.random()*(last*0.0008);
      const l = Math.min(o,c) - Math.random()*(last*0.0008);
      const v = 20 + Math.random()*120;
      candles.push({o,h,l,c,v});
      while (candles.length > maxCandles) candles.shift();
    }

    // update book + trades
    genBook();

    const dir = (Math.random() > 0.5) ? "up" : "down";
    const size = (Math.random()*0.35) + 0.00009;
    pushTrade(last, size, dir);

    // update market list slightly
    markets.forEach(m => {
      const mult = (Math.random()-0.5) * 0.0022;
      m.last = Math.max(0.0001, m.last * (1+mult));
      m.chg = clamp(m.chg + (Math.random()-0.5)*0.12, -12, 12);
      if (m.sym === pair) {
        m.last = last;
      }
    });

    // update 24h hi/lo
    hi24 = Math.max(hi24, last);
    lo24 = Math.min(lo24, last);
    vol24 += size*10;
    vol24q = vol24 * last;

    renderKPIs();
    renderBook();
    renderTrades();
    renderMarkets(marketSearch.value);
    drawChart();
  }

  // ---------- tabs (visual only) ----------
  document.querySelectorAll(".tab").forEach(t => {
    t.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      // for mock: keep Market Price only (ÐºÐ°Ðº Ð½Ð° ÑÐºÑ€Ð¸Ð½Ðµ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°Ñ‚ÑŒ Ð²ÐºÐ»Ð°Ð´ÐºÐ¸)
    });
  });

  // percent buttons
  document.querySelectorAll(".pctBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const pct = Number(btn.dataset.pct) / 100;
      const side = btn.dataset.side;
      if (side === "buy") {
        const v = bal.USDT * pct;
        buyAmount.value = (Math.floor(v*100)/100).toFixed(2);
      } else {
        const v = bal.BTC * pct;
        sellAmount.value = v.toFixed(8);
      }
      recalcFormHints();
    });
  });

  buyAmount.addEventListener("input", recalcFormHints);
  sellAmount.addEventListener("input", recalcFormHints);

  el("btnBuy").addEventListener("click", buyMarket);
  el("btnSell").addEventListener("click", sellMarket);

  marketSearch.addEventListener("input", (e) => renderMarkets(e.target.value));

  window.addEventListener("resize", () => {
    resizeCanvas();
    drawChart();
  });

  // ---------- boot ----------
  
  seedCandles();
  genBook();
  seedTrades();
  resizeCanvas();
  canvas.addEventListener("wheel", (e) => {
  e.preventDefault();

  visibleCandles += Math.sign(e.deltaY) * 4;
  visibleCandles = clamp(visibleCandles, minCandles, maxVisibleCandles);

  drawChart();
}, { passive: false });
let isDragging = false;
let lastX = 0;

canvas.addEventListener("mousedown", (e) => {
  isDragging = true;
  lastX = e.clientX;
});

window.addEventListener("mouseup", () => {
  isDragging = false;
});

window.addEventListener("mousemove", (e) => {
  if (!isDragging) return;

  const dx = e.clientX - lastX;
  lastX = e.clientX;

  candleOffset += Math.round(dx / 8);
  candleOffset = clamp(
    candleOffset,
    0,
    Math.max(0, candles.length - visibleCandles)
  );

  drawChart();
});

canvas.addEventListener("dblclick", () => {
  visibleCandles = 40;
  candleOffset = 0;
  drawChart();
});



  renderBalances();
  renderKPIs();
  renderBook();
  renderTrades();
  renderMarkets();
  recalcFormHints();
  drawChart();

function updatePriceOnly() {
  let directionFactor = 0;

if (priceDirection === "up") directionFactor = Math.random();
else if (priceDirection === "down") directionFactor = -Math.random();
else directionFactor = Math.random() - 0.5;

const drift = directionFactor * (last * 0.0007);


  const next = Math.max(0.0001, last + drift);

  const cur = candles[candles.length - 1];
  cur.c = next;
  cur.h = Math.max(cur.h, next);
  cur.l = Math.min(cur.l, next);
  cur.v += 1 + Math.random() * 5;

  last = next;

  if (Math.random() < 0.08) {
    const o = last;
    const c = last + (Math.random() - 0.5) * (last * 0.001);
    const h = Math.max(o, c) + Math.random() * (last * 0.0006);
    const l = Math.min(o, c) - Math.random() * (last * 0.0006);
    const v = 20 + Math.random() * 100;
    candles.push({ o, h, l, c, v });
    while (candles.length > maxCandles) candles.shift();
  }
}



  // live loop
  // price + chart (Ñ‡Ð°ÑÑ‚Ð¾)
setInterval(() => {
  updatePriceOnly();
  drawChart();
  renderKPIs();
}, 900);

// order book (Ð¼ÐµÐ´Ð»ÐµÐ½Ð½ÐµÐµ)
setInterval(() => {
  genBook();
  renderBook();
}, 3000);

// trades
setInterval(() => {
  const dir = Math.random() > 0.5 ? "up" : "down";
  const size = (Math.random() * 0.35) + 0.00009;
  pushTrade(last, size, dir);
  renderTrades();
}, 2000);

// markets
setInterval(() => {
  markets.forEach(m => {
    const mult = (Math.random() - 0.5) * 0.0015;
    m.last = Math.max(0.0001, m.last * (1 + mult));
    m.chg = clamp(m.chg + (Math.random() - 0.5) * 0.08, -12, 12);
    if (m.sym === pair) m.last = last;
  });
  renderMarkets(marketSearch.value);
}, 5000);

})();
</script>
</body>
</html>
